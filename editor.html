<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Centralizado</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group button { width: 100%; padding: 10px; margin-top: 5px; }
        .candidate-row { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
        .candidate-row input { flex: 1; }
        .add-btn, .save-btn { padding: 10px; margin-top: 10px; display: inline-block; background-color: #007bff; color: white; text-align: center; border: none; cursor: pointer; }
        .add-btn:hover, .save-btn:hover { background-color: #0056b3; }
        .notification { display: none; padding: 10px; margin-top: 20px; text-align: center; background-color: #4CAF50; color: white; border-radius: 5px; }
        .delete-btn { background-color: #f44336; color: white; padding: 5px; cursor: pointer; }
        .delete-btn:hover { background-color: #d32f2f; }
    </style>
</head>
<body>
    <h1>Editor de Encuestas</h1>
    <form id="surveyForm">
        <div class="form-group">
            <label for="date">Fecha de Encuesta:</label>
            <input type="date" id="date" required>
        </div>
        <div id="candidatesContainer">
            <h3>Candidatos</h3>
        </div>
        <button type="button" id="addCandidateBtn" class="add-btn">Agregar Candidato</button>
        <button type="submit" class="save-btn">Guardar Encuesta</button>
    </form>
    <div id="notification" class="notification">Encuesta Guardada Correctamente</div>

    <h3>Encuestas Guardadas</h3>
    <table id="savedSurveysTable" border="1" style="width: 100%; text-align: left;">
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <!-- Encuestas se renderizarán dinámicamente aquí -->
        </tbody>
    </table>

    <script>
        const candidatesContainer = document.getElementById('candidatesContainer');
        const surveyForm = document.getElementById('surveyForm');
        const notification = document.getElementById('notification');
        const savedSurveysTable = document.getElementById('savedSurveysTable').getElementsByTagName('tbody')[0];

        // Agregar un nuevo candidato
        document.getElementById('addCandidateBtn').addEventListener('click', () => {
            const row = document.createElement('div');
            row.className = 'candidate-row';
            row.innerHTML = `
                <input type="text" placeholder="Nombre del candidato" class="candidate-name" required>
                <input type="text" placeholder="Región" class="candidate-region" required>
                <input type="number" placeholder="Aprobado (%)" class="aprobado" min="0" max="100" required>
                <input type="number" placeholder="Desaprobado (%)" class="desaprobado" min="0" max="100" required>
                <input type="number" placeholder="No sabe/no opina (%)" class="no-sabe" min="0" max="100" required>
                <input type="file" class="candidate-image" accept="image/*">
                <button class="delete-btn" onclick="this.parentElement.remove()">Eliminar</button>
            `;
            candidatesContainer.appendChild(row);
        });

        // Guardar encuesta
        surveyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('date').value;
            const candidates = Array.from(document.querySelectorAll('.candidate-row')).map(row => {
                const imageInput = row.querySelector('.candidate-image');
                const imageUrl = imageInput && imageInput.files.length ? URL.createObjectURL(imageInput.files[0]) : ''; // Guardar la URL de la imagen
                return {
                    name: row.querySelector('.candidate-name').value,
                    region: row.querySelector('.candidate-region').value,
                    percentages: {
                        aprobado: parseFloat(row.querySelector('.aprobado').value),
                        desaprobado: parseFloat(row.querySelector('.desaprobado').value),
                        noSabe: parseFloat(row.querySelector('.no-sabe').value),
                    },
                    image: imageUrl // Incluir la URL de la imagen
                };
            });

            const surveys = { date, candidates };
            try {
                await fetch('save_data.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(surveys)
                });
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
                loadSavedSurveys(); // Cargar las encuestas guardadas
            } catch (error) {
                alert('Error al guardar los datos: ' + error.message);
            }
        });

        // Cargar encuestas guardadas
        async function loadSavedSurveys() {
            try {
                const response = await fetch('datos.json');
                const surveys = await response.json();
                savedSurveysTable.innerHTML = ''; // Limpiar tabla antes de cargar los datos
                surveys.forEach((survey, index) => {
                    survey.candidates.forEach(candidate => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${candidate.image}" alt="Foto de ${candidate.name}" width="50" height="50"></td>
                            <td>${candidate.name}</td>
                            <td>${candidate.region}</td>
                            <td>${candidate.percentages.aprobado}%</td>
                            <td>${candidate.percentages.desaprobado}%</td>
                            <td>${candidate.percentages.noSabe}%</td>
                            <td><button onclick="deleteSurvey(${index})">Eliminar</button></td>
                        `;
                        savedSurveysTable.appendChild(row);
                    });
                });
            } catch (error) {
                alert('Error al cargar los datos: ' + error.message);
            }
        }

        loadSavedSurveys(); // Cargar las encuestas cuando se carga la página
    </script>
</body>
</html>
